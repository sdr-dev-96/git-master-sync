#!/bin/bash

# Script to update all local branches with master
# Deletes local branches that are merged or deleted remotely
# Usage: update-all-branches [--dry-run] [-out <branch|origin/branch>]

set -e

SOURCE_BRANCH="master"
DRY_RUN=false

current_branch=$(git branch --show-current)
echo "Current branch : $current_branch"

# Default output branch
OUT_BRANCH="$current_branch"

# Parse args ONCE
while [[ $# -gt 0 ]]; do
  case "$1" in
    --dry-run)
      DRY_RUN=true
      echo "ğŸ§ª  Dry-run mode enabled: no push or deletion will be performed."
      shift
      ;;
    -out|--out)
      if [[ -z "${2:-}" ]]; then
        echo "âŒ  Error: -out requires a branch name"
        exit 1
      fi
      OUT_BRANCH="$2"
      shift 2
      ;;
    *)
      echo "âŒ  Unknown parameter: $1"
      exit 1
      ;;
  esac
done

echo "ğŸ“¡  Fetching remote..."
git fetch --all --prune

echo "ğŸŒ€  Checking out $SOURCE_BRANCH"
git checkout "$SOURCE_BRANCH"
git pull origin "$SOURCE_BRANCH"

# List all local branches except SOURCE_BRANCH
branches=$(git for-each-ref --format='%(refname:short)' refs/heads/ | grep -v "^$SOURCE_BRANCH$" || true)

for branch in $branches; do
  echo "ğŸ”  Processing branch $branch..."
  reason=""

  # Check if branch should be deleted (either remote branch is gone OR already merged)
  if ! git show-ref --quiet refs/remotes/origin/"$branch"; then
    reason="Remote branch origin/$branch no longer exists."
  elif git branch --merged "$SOURCE_BRANCH" | grep -qw "$branch"; then
    reason="Branch $branch has already been merged into $SOURCE_BRANCH."
  fi

  if [ -n "$reason" ]; then
    echo "âœ… $reason"
    if $DRY_RUN; then
      echo "ğŸš«  Deletion SKIPPED (dry-run)"
    else
      echo "ğŸ—‘ï¸  Force deleting local branch $branch"
      git branch -D "$branch"
    fi
    continue
  fi

  echo "ğŸ”„  Updating $branch"
  git checkout "$branch"
  git pull --ff-only || true

  echo "ğŸ”„  Merging $SOURCE_BRANCH into $branch"
  set +e
  git merge "$SOURCE_BRANCH" --no-edit
  merge_status=$?
  set -e

  if [ $merge_status -ne 0 ]; then
    echo "âš ï¸  Conflict in $branch. Resolve it manually."
    exit 1
  fi

  if $DRY_RUN; then
    echo "ğŸš«  Push SKIPPED (dry-run)"
  else
    echo "ğŸ“¤  Pushing $branch â†’ origin"
    git push origin "$branch"
  fi

  echo "âœ…  Update complete for $branch."
done

# --- Resolve OUT_BRANCH (supports "origin/foo") and auto-create local if needed ---

# If OUT_BRANCH is origin/foo, local branch should be foo
if [[ "$OUT_BRANCH" == origin/* ]]; then
  out_remote="$OUT_BRANCH"          # origin/foo
  out_local="${OUT_BRANCH#origin/}" # foo
else
  out_local="$OUT_BRANCH"           # foo
  out_remote="origin/$OUT_BRANCH"   # origin/foo
fi

# If local out branch exists, good. Otherwise try to create from remote.
if git show-ref --quiet "refs/heads/$out_local"; then
  final_branch="$out_local"
elif git show-ref --quiet "refs/remotes/$out_remote"; then
  echo "ğŸŒ±  Creating local branch '$out_local' from '$out_remote'"
  git checkout -b "$out_local" "$out_remote"
  final_branch="$out_local"
else
  echo "âŒ  Output branch '$OUT_BRANCH' not found (local or remote). Using '$SOURCE_BRANCH' instead."
  final_branch="$SOURCE_BRANCH"
fi

# If we already checked out when creating, avoid double checkout
current_now=$(git branch --show-current)
if [[ "$current_now" != "$final_branch" ]]; then
  echo "ğŸšª  Switching to output branch: $final_branch"
  git checkout "$final_branch"
else
  echo "ğŸšª  Staying on output branch: $final_branch"
fi

echo "ğŸ  Script finished."
if $DRY_RUN; then
  echo "ğŸ§ª  (dry-run) No push or deletion was performed."
fi
