#!/bin/bash

# Script to update all local branches with master
# Deletes local branches that are merged or deleted remotely
# Usage: update-all-branches [--dry-run]

set -e

SOURCE_BRANCH="master"
DRY_RUN=false

current_branch=$(git branch --show-current)
echo "Current branch : $current_branch"

# We will return to the current branch at the end of the script
OUT_BRANCH="$current_branch"

# Check if --dry-run is passed
if [[ "$1" == "--dry-run" ]]; then
  DRY_RUN=true
  echo "ğŸ§ª  Dry-run mode enabled: no push or deletion will be performed."
fi

echo "ğŸ“¡  Fetching remote..."
git fetch --all --prune

echo "ğŸŒ€  Checking out $SOURCE_BRANCH"
git checkout "$SOURCE_BRANCH"
git pull origin "$SOURCE_BRANCH"

# List all local branches except master
branches=$(git for-each-ref --format='%(refname:short)' refs/heads/ | grep -v "^$SOURCE_BRANCH$")

for branch in $branches; do
  echo "ğŸ”  Processing branch $branch..."
  reason=""

  # Check if branch should be deleted (either remote branch is gone OR already merged)
  if ! git show-ref --quiet refs/remotes/origin/"$branch"; then
    reason="Remote branch origin/$branch no longer exists."
  elif git branch --merged "$SOURCE_BRANCH" | grep -qw "$branch"; then
    reason="Branch $branch has already been merged into $SOURCE_BRANCH."
  fi

  # If a reason was found, force delete the branch
  if [ -n "$reason" ]; then
    echo "âœ… $reason"

    if $DRY_RUN; then
      echo "ğŸš«  Deletion SKIPPED (dry-run)"
    else
      echo "ğŸ—‘ï¸  Force deleting local branch $branch"
      git branch -D "$branch"
    fi
    continue
  fi

  # Otherwise, update the branch
  echo "ğŸ”„  Updating $branch"
  git checkout "$branch"
  git pull --ff-only || true  # fast-forward si possible, sinon on merge

  echo "ğŸ”„  Merging $SOURCE_BRANCH into $branch"
  set +e
  git merge "$SOURCE_BRANCH" --no-edit
  merge_status=$?
  set -e

  if [ $merge_status -ne 0 ]; then
    echo "âš ï¸  Conflict in $branch. Resolve it manually."
    exit 1
  fi

  while [[ $# -gt 0 ]]; do
    case "$1" in
      --dry-run)
        DRY_RUN=true
        echo "ğŸ§ª  Dry-run mode enabled: no push or deletion will be performed."
        shift
        ;;
      -out|--out)
        if [[ -z "$2" ]]; then
          echo "âŒ  Error: -out requires a branch name"
          exit 1
        fi
        OUT_BRANCH="$2"
        shift 2
        ;;
      *)
        echo "âŒ  Unknown parameter: $1"
        exit 1
        ;;
    esac
  done

  echo "âœ…  Update complete for $branch."
done

if ! git show-ref --quiet refs/heads/"$OUT_BRANCH"; then
  echo "âŒ  Output branch '$OUT_BRANCH' does not exist locally. Using current branch '$SOURCE_BRANCH' instead."
  OUT_BRANCH="$SOURCE_BRANCH"
fi

echo "ğŸšª  Switching to output branch: $OUT_BRANCH"
git checkout "$OUT_BRANCH"

echo "ğŸ  Script finished."
if $DRY_RUN; then
  echo "ğŸ§ª  (dry-run) No push or deletion was performed."
fi
